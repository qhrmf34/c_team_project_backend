<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hotel_project.member_jpa.cart.mapper.CartMapper">

    <!-- ResultMap 정의 - 상세 정보 포함 -->
    <resultMap id="CartDetailResultMap" type="com.hotel_project.member_jpa.cart.dto.CartDto">
        <id property="id" column="cart_id"/>
        <result property="memberId" column="member_id"/>
        <result property="roomId" column="room_id"/>
        <result property="createdAt" column="created_at"/>

        <!-- MemberDto 매핑 -->
        <association property="memberDto" javaType="com.hotel_project.member_jpa.member.dto.MemberDto">
            <id property="id" column="member_id"/>
            <result property="name" column="member_name"/>
            <result property="email" column="member_email"/>
        </association>

        <!-- RoomDto 매핑 -->
        <association property="roomDto" javaType="com.hotel_project.hotel_jpa.room.dto.RoomDto">
            <id property="id" column="room_id"/>
            <result property="roomName" column="room_name"/>
            <result property="basePrice" column="base_price"/>
            <result property="maxOccupancy" column="max_occupancy"/>
            <result property="roomSize" column="room_size"/>
            <result property="hotelId" column="hotel_id"/>
        </association>
    </resultMap>

    <!-- 장바구니 조회 (회원별) - 상세 정보 포함 -->
    <select id="findByMemberId" resultMap="CartDetailResultMap">
        SELECT
            c.id as cart_id,
            c.member_id,
            c.room_id,
            c.created_at,
            m.name as member_name,
            m.email as member_email,
            r.room_name,
            r.base_price,
            r.max_occupancy,
            r.room_size,
            r.hotel_id
        FROM cart_tbl c
                 LEFT JOIN member_tbl m ON c.member_id = m.id
                 LEFT JOIN room_tbl r ON c.room_id = r.id
        WHERE c.member_id = #{memberId}
        ORDER BY c.created_at DESC
    </select>

    <!-- 장바구니 존재 여부 -->
    <select id="existsByMemberIdAndRoomId" resultType="int">
        SELECT COUNT(*)
        FROM cart_tbl
        WHERE member_id = #{memberId} AND room_id = #{roomId}
    </select>

    <!-- 장바구니 개수 조회 -->
    <select id="countByMemberId" resultType="int">
        SELECT COUNT(*)
        FROM cart_tbl
        WHERE member_id = #{memberId}
    </select>

    <!-- 객실 ID 목록 조회 (회원별) -->
    <select id="findRoomIdsByMemberId" resultType="long">
        SELECT room_id
        FROM cart_tbl
        WHERE member_id = #{memberId}
        ORDER BY created_at DESC
    </select>

</mapper>