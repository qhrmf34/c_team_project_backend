<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hotel_project.member_jpa.cart.mapper.CartMapper">

    <!-- ResultMap 정의 - 상세 정보 포함 -->
    <resultMap id="CartDetailResultMap" type="com.hotel_project.member_jpa.cart.dto.CartDto">
        <id property="id" column="cart_id"/>
        <result property="memberId" column="member_id"/>
        <result property="hotelId" column="hotel_id"/>
        <result property="createdAt" column="created_at"/>

        <!-- MemberDto 매핑 -->
        <association property="memberDto" javaType="com.hotel_project.member_jpa.member.dto.MemberDto">
            <id property="id" column="member_id"/>
            <result property="firstName" column="member_first_name"/>
            <result property="lastName" column="member_last_name"/>
            <result property="email" column="member_email"/>
        </association>

        <!-- HotelDto 매핑 -->
        <association property="hotelDto" javaType="com.hotel_project.hotel_jpa.hotel.dto.HotelDto">
            <id property="id" column="hotel_id"/>
            <result property="cityId" column="city_id"/>
            <result property="hotelType" column="hotel_type"/>
            <result property="hotelName" column="hotel_name"/>
            <result property="hotelLatitude" column="hotel_latitude"/>
            <result property="hotelLongitude" column="hotel_longitude"/>
            <result property="hotelContent" column="hotel_content"/>
            <result property="hotelStar" column="hotel_star"/>
            <result property="freebiesNumber" column="freebies_number"/>
            <result property="hotelNumber" column="hotel_number"/>
            <result property="checkinTime" column="checkin_time"/>
            <result property="checkoutTime" column="checkout_time"/>
            <result property="hotelRating" column="hotel_rating"/>
        </association>
    </resultMap>

    <!-- 장바구니 조회 -->
    <select id="findByMemberId" resultMap="CartDetailResultMap">
        SELECT
        c.id AS cart_id,
        c.member_id,
        c.hotel_id,
        c.created_at,
        m.first_name AS member_first_name,
        m.last_name AS member_last_name,
        m.email AS member_email,
        h.city_id,
        h.hotel_type,
        h.hotel_name,
        h.hotel_latitude,
        h.hotel_longitude,
        h.hotel_content,
        h.hotel_star,
        h.freebies_number,
        h.hotel_number,
        h.checkin_time,
        h.checkout_time,
        h.hotel_rating
        FROM cart_tbl c
        LEFT JOIN member_tbl m ON c.member_id = m.id
        LEFT JOIN hotel_tbl h ON c.hotel_id = h.id
        WHERE c.member_id = #{memberId}
        ORDER BY c.created_at DESC
        <if test="offset != null and size != null">
            LIMIT #{size} OFFSET #{offset}
        </if>
    </select>

    <!-- 장바구니 존재 여부 -->
    <select id="existsByMemberIdAndHotelId" resultType="int">
        SELECT COUNT(*)
        FROM cart_tbl
        WHERE member_id = #{memberId} AND hotel_id = #{hotelId}
    </select>

    <!-- 장바구니 개수 조회 -->
    <select id="countByMemberId" resultType="int">
        SELECT COUNT(*)
        FROM cart_tbl
        WHERE member_id = #{memberId}
    </select>

    <!-- 호텔 ID 목록 조회 (회원별) -->
    <select id="findHotelIdsByMemberId" resultType="long">
        SELECT c.hotel_id
        FROM cart_tbl c
        WHERE c.member_id = #{memberId}
        ORDER BY c.created_at DESC
    </select>

</mapper>