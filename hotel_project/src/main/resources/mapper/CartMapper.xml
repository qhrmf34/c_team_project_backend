<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hotel_project.member_jpa.cart.mapper.CartMapper">

    <!-- 기존 CartDetailResultMap -->
    <resultMap id="CartDetailResultMap" type="com.hotel_project.member_jpa.cart.dto.CartDto">
        <id property="id" column="cart_id"/>
        <result property="memberId" column="member_id"/>
        <result property="hotelId" column="hotel_id"/>
        <result property="createdAt" column="created_at"/>

        <association property="memberDto" javaType="com.hotel_project.member_jpa.member.dto.MemberDto">
            <id property="id" column="member_id"/>
            <result property="firstName" column="member_first_name"/>
            <result property="lastName" column="member_last_name"/>
            <result property="email" column="member_email"/>
        </association>

        <association property="hotelDto" javaType="com.hotel_project.hotel_jpa.hotel.dto.HotelDto">
            <id property="id" column="hotel_id"/>
            <result property="cityId" column="city_id"/>
            <result property="hotelType" column="hotel_type"/>
            <result property="hotelName" column="hotel_name"/>
            <result property="hotelLatitude" column="hotel_latitude"/>
            <result property="hotelLongitude" column="hotel_longitude"/>
            <result property="hotelContent" column="hotel_content"/>
            <result property="hotelStar" column="hotel_star"/>
            <result property="freebiesNumber" column="freebies_number"/>
            <result property="hotelNumber" column="hotel_number"/>
            <result property="checkinTime" column="checkin_time"/>
            <result property="checkoutTime" column="checkout_time"/>
            <result property="hotelRating" column="hotel_rating"/>
        </association>
    </resultMap>

    <!-- ✅ WishlistHotelDto용 ResultMap -->
    <resultMap id="WishlistHotelResultMap" type="com.hotel_project.member_jpa.cart.dto.WishlistHotelDto">
        <result property="cartId" column="cart_id"/>
        <result property="memberId" column="member_id"/>
        <result property="hotelId" column="hotel_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="hotelName" column="hotel_name"/>
        <result property="hotelType" column="hotel_type"/>
        <result property="hotelStar" column="hotel_star"/>
        <result property="hotelImage" column="hotel_image"/>
        <result property="imageCount" column="image_count"/>
        <result property="minPrice" column="min_price"/>
        <result property="cityName" column="city_name"/>
        <result property="countryName" column="country_name"/>
        <result property="amenitiesCount" column="amenities_count"/>
        <result property="hotelRating" column="hotel_rating"/>
        <result property="reviewCount" column="review_count"/>
    </resultMap>

    <!-- ✅ 찜 목록 조회 (WishlistHotelDto) -->
    <select id="findWishlistByMemberId" resultMap="WishlistHotelResultMap">
        SELECT
        c.id AS cart_id,
        c.member_id,
        c.hotel_id,
        c.created_at,

        -- 호텔 기본 정보
        h.hotel_name,
        h.hotel_type,
        h.hotel_star,

        -- 첫 번째 이미지
        (SELECT hi.hotel_image_path
        FROM hotel_image_tbl hi
        WHERE hi.hotel_id = h.id
        ORDER BY hi.created_at ASC
        LIMIT 1) AS hotel_image,

        -- 이미지 개수
        (SELECT COUNT(*)
        FROM hotel_image_tbl hi2
        WHERE hi2.hotel_id = h.id) AS image_count,

        -- 최저 가격
        (SELECT MIN(r.base_price)
        FROM room_tbl r
        WHERE r.hotel_id = h.id) AS min_price,

        -- 도시 및 국가명
        ci.city_name,
        co.country_name,

        -- 편의시설 개수
        (SELECT COUNT(*)
        FROM hotel_amenities_tbl ha
        WHERE ha.hotel_id = h.id) AS amenities_count,

        -- ✅ 리뷰에서 계산된 실제 평균 평점
        COALESCE((SELECT AVG(rev.rating)
        FROM reviews_tbl rev
        WHERE rev.hotel_id = h.id), 0.0) AS hotel_rating,

        -- 리뷰 개수
        (SELECT COUNT(*)
        FROM reviews_tbl rev
        WHERE rev.hotel_id = h.id) AS review_count

        FROM cart_tbl c
        INNER JOIN hotel_tbl h ON c.hotel_id = h.id
        LEFT JOIN city_tbl ci ON h.city_id = ci.id
        LEFT JOIN country_tbl co ON ci.country_id = co.id
        WHERE c.member_id = #{memberId}
        ORDER BY c.created_at DESC
        <if test="offset != null and size != null">
            LIMIT #{size} OFFSET #{offset}
        </if>
    </select>

    <!-- 기존 findByMemberId (상세 정보용) -->
    <select id="findByMemberId" resultMap="CartDetailResultMap">
        SELECT
        c.id AS cart_id,
        c.member_id,
        c.hotel_id,
        c.created_at,
        m.first_name AS member_first_name,
        m.last_name AS member_last_name,
        m.email AS member_email,
        h.city_id,
        h.hotel_type,
        h.hotel_name,
        h.hotel_latitude,
        h.hotel_longitude,
        h.hotel_content,
        h.hotel_star,
        h.freebies_number,
        h.hotel_number,
        h.checkin_time,
        h.checkout_time,
        h.hotel_rating
        FROM cart_tbl c
        LEFT JOIN member_tbl m ON c.member_id = m.id
        LEFT JOIN hotel_tbl h ON c.hotel_id = h.id
        WHERE c.member_id = #{memberId}
        ORDER BY c.created_at DESC
        <if test="offset != null and size != null">
            LIMIT #{size} OFFSET #{offset}
        </if>
    </select>

    <!-- 장바구니 존재 여부 -->
    <select id="existsByMemberIdAndHotelId" resultType="int">
        SELECT COUNT(*)
        FROM cart_tbl
        WHERE member_id = #{memberId} AND hotel_id = #{hotelId}
    </select>

    <!-- 장바구니 개수 조회 -->
    <select id="countByMemberId" resultType="int">
        SELECT COUNT(*)
        FROM cart_tbl
        WHERE member_id = #{memberId}
    </select>

    <!-- 호텔 ID 목록 조회 (회원별) -->
    <select id="findHotelIdsByMemberId" resultType="long">
        SELECT c.hotel_id
        FROM cart_tbl c
        WHERE c.member_id = #{memberId}
        ORDER BY c.created_at DESC
    </select>

</mapper>