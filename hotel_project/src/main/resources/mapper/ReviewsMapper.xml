<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hotel_project.review_jpa.reviews.mapper.ReviewsMapper">

    <resultMap id="ReviewsDtoMap" type="com.hotel_project.review_jpa.reviews.dto.ReviewsDto">
        <id property="id" column="id"/>
        <result property="memberId" column="member_id"/>
        <result property="hotelId" column="hotel_id"/>
        <result property="reservationsId" column="reservations_id"/>
        <result property="rating" column="rating"/>
        <result property="reviewContent" column="review_content"/>
        <result property="reviewCard" column="review_card"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="profileImage" column="profileImage"/>
        <!-- 회원 정보 (Service에서 displayName 처리) -->
        <result property="provider" column="provider"/>
        <result property="firstName" column="first_name"/>
        <result property="lastName" column="last_name"/>
        <result property="email" column="email"/>
    </resultMap>

    <!-- 모든 CASE문 제거하고 단순하게 -->
    <select id="findByHotelId" resultMap="ReviewsDtoMap">
        SELECT
            r.id,
            r.member_id,
            r.hotel_id,
            r.reservations_id,
            r.rating,
            r.review_content,
            r.review_card,
            r.created_at,
            r.updated_at,
            m.provider,
            m.first_name,
            m.last_name,
            m.email,
            mi.member_image_path as profileImage
        FROM reviews_tbl r
                 LEFT JOIN member_tbl m ON r.member_id = m.id
                 LEFT JOIN member_image_tbl mi ON m.id = mi.member_id AND mi.image_type = 'PROFILE'
        WHERE r.hotel_id = #{hotelId}
        ORDER BY r.created_at DESC
    </select>

    <select id="findFilteredReviews" resultMap="ReviewsDtoMap">
        SELECT
        r.id,
        r.member_id,
        r.hotel_id,
        r.reservations_id,
        r.rating,
        r.review_content,
        r.review_card,
        r.created_at,
        r.updated_at,
        m.provider,
        m.first_name,
        m.last_name,
        m.email,
        mi.member_image_path as profileImage
        FROM reviews_tbl r
        LEFT JOIN member_tbl m ON r.member_id = m.id
        LEFT JOIN member_image_tbl mi ON m.id = mi.member_id AND mi.image_type = 'PROFILE'
        WHERE r.hotel_id = #{hotelId}
        <if test="reviewCard != null">
            AND r.review_card = #{reviewCard}
        </if>
        <choose>
            <when test="sortBy == 'highest'">
                ORDER BY r.rating DESC, r.created_at DESC
            </when>
            <when test="sortBy == 'lowest'">
                ORDER BY r.rating ASC, r.created_at DESC
            </when>
            <otherwise>
                ORDER BY r.created_at DESC
            </otherwise>
        </choose>
    </select>

    <select id="getReviewCardStatsRaw" resultType="map">
        SELECT
            review_card as reviewCard,
            COUNT(*) as count
        FROM reviews_tbl
        WHERE hotel_id = #{hotelId}
        GROUP BY review_card
    </select>

    <select id="getHotelRatingStats" resultType="map">
        SELECT
            COALESCE(AVG(rating), 0.0) as averageRating,
            COUNT(*) as reviewCount
        FROM reviews_tbl
        WHERE hotel_id = #{hotelId}
    </select>

    <select id="existsByMemberIdAndHotelId" resultType="boolean">
        SELECT
            CASE
                WHEN COUNT(*) > 0 THEN TRUE
                ELSE FALSE
                END
        FROM reviews_tbl
        WHERE member_id = #{memberId}
          AND hotel_id = #{hotelId}
    </select>

    <select id="findMyReview" resultMap="ReviewsDtoMap">
        SELECT
            r.id,
            r.member_id,
            r.hotel_id,
            r.reservations_id,
            r.rating,
            r.review_content,
            r.review_card,
            r.created_at,
            r.updated_at,
            m.provider,
            m.first_name,
            m.last_name,
            m.email,
            mi.member_image_path as profileImage
        FROM reviews_tbl r
                 LEFT JOIN member_tbl m ON r.member_id = m.id
                 LEFT JOIN member_image_tbl mi ON m.id = mi.member_id AND mi.image_type = 'PROFILE'
        WHERE r.hotel_id = #{hotelId}
          AND r.member_id = #{memberId}
            LIMIT 1
    </select>

    <select id="checkReviewEligibility" resultType="map">
        SELECT
            CASE
                -- 1. 이미 이 호텔에 리뷰를 작성했는지 체크
                WHEN EXISTS (
                    SELECT 1 FROM reviews_tbl
                    WHERE member_id = #{memberId}
                      AND hotel_id = #{hotelId}
                ) THEN 'ALREADY_WRITTEN'

                -- 2. 이 호텔에 예약한 적이 있는지 체크
                WHEN NOT EXISTS (
                    SELECT 1 FROM reservations_tbl res
                                      INNER JOIN room_tbl r ON res.room_id = r.id
                    WHERE r.hotel_id = #{hotelId}
                      AND res.member_id = #{memberId}
                ) THEN 'NO_BOOKING'

                -- 3. 결제 완료 &amp; 체크아웃 날짜가 지난 예약이 있는지 체크
                WHEN EXISTS (
                    SELECT 1 FROM reservations_tbl res
                                      INNER JOIN room_tbl r ON res.room_id = r.id
                                      LEFT JOIN payments_tbl p ON res.id = p.reservations_id
                    WHERE r.hotel_id = #{hotelId}
                      AND res.member_id = #{memberId}
                      AND res.reservations_status = TRUE
                      AND p.payment_status = 'paid'
                      AND res.check_out_date <![CDATA[<]]> CURDATE()
                ) THEN 'ELIGIBLE'

                -- 4. 예약은 있지만 아직 체크아웃 날짜가 안 지났거나 결제가 안됨
                ELSE 'NOT_ELIGIBLE'
                END as status,
            (
                SELECT MAX(res.check_in_date)
                FROM reservations_tbl res
                         INNER JOIN room_tbl r ON res.room_id = r.id
                         LEFT JOIN payments_tbl p ON res.id = p.reservations_id
                WHERE r.hotel_id = #{hotelId}
                  AND res.member_id = #{memberId}
                  AND res.reservations_status = TRUE
                  AND p.payment_status = 'paid'
            ) as checkIn,
            (
                SELECT MAX(res.check_out_date)
                FROM reservations_tbl res
                         INNER JOIN room_tbl r ON res.room_id = r.id
                         LEFT JOIN payments_tbl p ON res.id = p.reservations_id
                WHERE r.hotel_id = #{hotelId}
                  AND res.member_id = #{memberId}
                  AND res.reservations_status = TRUE
                  AND p.payment_status = 'paid'
            ) as checkOut,
            (
                SELECT res.id
                FROM reservations_tbl res
                         INNER JOIN room_tbl r ON res.room_id = r.id
                         LEFT JOIN payments_tbl p ON res.id = p.reservations_id
                WHERE r.hotel_id = #{hotelId}
                  AND res.member_id = #{memberId}
                  AND res.reservations_status = TRUE
                  AND p.payment_status = 'paid'
                ORDER BY res.check_out_date DESC
                       LIMIT 1
            ) as reservationId
    </select>
    <insert id="insertReview" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reviews_tbl (
            member_id,
            hotel_id,
            reservations_id,
            rating,
            review_content,
            review_card,
            created_at,
            updated_at
        ) VALUES (
                     #{memberId},
                     #{hotelId},
                     #{reservationsId},
                     #{rating},
                     #{reviewContent},
                     #{reviewCard},
                     NOW(),
                     NOW()
                 )
    </insert>

    <update id="updateReview">
        UPDATE reviews_tbl
        SET rating = #{rating},
            review_content = #{reviewContent},
            review_card = #{reviewCard},
            updated_at = NOW()
        WHERE id = #{id}
          AND member_id = #{memberId}
    </update>

    <delete id="deleteReview">
        DELETE FROM reviews_tbl
        WHERE id = #{id}
          AND member_id = #{memberId}
    </delete>

    <select id="isReviewOwner" resultType="boolean">
        SELECT
            CASE
                WHEN COUNT(*) > 0 THEN TRUE
                ELSE FALSE
                END
        FROM reviews_tbl
        WHERE id = #{reviewId}
          AND member_id = #{memberId}
    </select>

</mapper>