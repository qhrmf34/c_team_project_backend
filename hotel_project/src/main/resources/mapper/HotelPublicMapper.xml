<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hotel_project.hotel_jpa.hotel.mapper.HotelPublicMapper">


    <!-- 호텔 검색 -->
    <!-- 모든 호텔 표시 + 예약 가능만 카운트 -->
    <select id="searchHotels" resultType="com.hotel_project.hotel_jpa.hotel.dto.HotelSummaryDto">
        WITH
        <choose>
            <when test="checkIn != null and checkOut != null">
                date_series AS (
                SELECT DATE_ADD(#{checkIn}, INTERVAL seq DAY) as date
                FROM (
                SELECT 0 as seq UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL
                SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL
                SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL
                SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL
                SELECT 12 UNION ALL SELECT 13 UNION ALL SELECT 14 UNION ALL
                SELECT 15 UNION ALL SELECT 16 UNION ALL SELECT 17 UNION ALL
                SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20 UNION ALL
                SELECT 21 UNION ALL SELECT 22 UNION ALL SELECT 23 UNION ALL
                SELECT 24 UNION ALL SELECT 25 UNION ALL SELECT 26 UNION ALL
                SELECT 27 UNION ALL SELECT 28 UNION ALL SELECT 29 UNION ALL SELECT 30
                ) seq_table
                WHERE DATE_ADD(#{checkIn}, INTERVAL seq DAY) &lt; #{checkOut}
                ),
                night_count AS (
                SELECT COUNT(*) as nights FROM date_series
                ),
                room_daily_prices AS (
                SELECT
                r.hotel_id,
                r.id as room_id,
                ds.date,
                rp.price as daily_price,
                rp.id as pricing_id
                FROM room_tbl r
                CROSS JOIN date_series ds
                LEFT JOIN room_pricing_tbl rp
                ON r.id = rp.room_id
                AND rp.date = ds.date
                ),
                room_prices AS (
                SELECT
                hotel_id,
                room_id,
                SUM(daily_price) as total_price,
                COUNT(pricing_id) as pricing_count,
                (SELECT nights FROM night_count) as expected_nights
                FROM room_daily_prices
                GROUP BY hotel_id, room_id
                HAVING pricing_count = expected_nights
                AND total_price > 0
                ),
                min_hotel_prices AS (
                SELECT
                rp.hotel_id,
                MIN(rp.total_price) as min_total_price,
                MIN(rp.total_price) / nc.nights as avg_nightly_price
                FROM room_prices rp
                CROSS JOIN night_count nc
                GROUP BY rp.hotel_id, nc.nights
                ),
                base_prices AS (
                SELECT
                hotel_id,
                MIN(base_price) as min_total_price,
                MIN(base_price) as avg_nightly_price
                FROM room_tbl
                GROUP BY hotel_id
                ),
                -- ✅ 호텔별 예약 가능 여부 체크 (room_pricing 있고 + 결제 예약 없어야 가능)
                hotel_availability AS (
                SELECT
                rp.hotel_id,
                -- room_prices에 있고 + 예약되지 않은 방이 있으면 1
                MAX(CASE
                WHEN NOT EXISTS (
                SELECT 1
                FROM reservations_tbl res
                INNER JOIN payments_tbl p ON res.id = p.reservations_id
                WHERE res.room_id = rp.room_id
                AND res.reservations_status = TRUE
                AND p.payment_status = 'paid'
                AND (
                (res.check_in_date &lt;= #{checkIn} AND res.check_out_date > #{checkIn})
                OR (res.check_in_date &lt; #{checkOut} AND res.check_out_date >= #{checkOut})
                OR (res.check_in_date >= #{checkIn} AND res.check_out_date &lt;= #{checkOut})
                )
                ) THEN 1
                ELSE 0
                END) as has_available_room
                FROM room_prices rp  -- ✅ room_prices (room_pricing 있는 것만)
                GROUP BY rp.hotel_id
                )
            </when>
            <otherwise>
                base_prices AS (
                SELECT
                hotel_id,
                MIN(base_price) as min_total_price,
                MIN(base_price) as avg_nightly_price
                FROM room_tbl
                GROUP BY hotel_id
                )
            </otherwise>
        </choose>

        SELECT
        h.id,
        h.hotel_name as title,
        (SELECT hi.hotel_image_path
        FROM hotel_image_tbl hi
        WHERE hi.hotel_id = h.id
        ORDER BY hi.created_at ASC
        LIMIT 1) as image,
        (SELECT COUNT(*)
        FROM hotel_image_tbl hi2
        WHERE hi2.hotel_id = h.id) as imageCount,

        <choose>
            <when test="checkIn != null and checkOut != null">
                -- room_pricing 있으면 우선, 없으면 base_price
                COALESCE(mhp.min_total_price, bp.min_total_price) as price,
            </when>
            <otherwise>
                bp.min_total_price as price,
            </otherwise>
        </choose>

        'KRW' as currency,
        CONCAT(c.city_name, ', ', co.country_name) as location,
        h.hotel_star as stars,
        NULL as type,
        h.hotel_type as hotelType,
        (SELECT COUNT(*)
        FROM hotel_amenities_tbl ha
        WHERE ha.hotel_id = h.id) as amenitiesCount,
        -- 리뷰 테이블에서 실제 평균 평점 계산
        ROUND(COALESCE((SELECT AVG(rev.rating)
        FROM reviews_tbl rev
        WHERE rev.hotel_id = h.id), 0.0), 1) as rating,

        NULL as ratingText,

        -- 리뷰 개수도 실제 값으로
        (SELECT COUNT(*)
        FROM reviews_tbl rev
        WHERE rev.hotel_id = h.id) as reviewCount,


        <choose>
            <when test="checkIn != null and checkOut != null">
                -- ✅ 예약 가능한 방이 있으면 TRUE, 없으면 FALSE
                CASE WHEN ha.has_available_room = 1 THEN TRUE ELSE FALSE END as available
            </when>
            <otherwise>
                -- 날짜 선택 안 함: 항상 TRUE
                TRUE as available
            </otherwise>
        </choose>

        FROM hotel_tbl h
        LEFT JOIN city_tbl c ON h.city_id = c.id
        LEFT JOIN country_tbl co ON c.country_id = co.id

        <choose>
            <when test="checkIn != null and checkOut != null">
                LEFT JOIN min_hotel_prices mhp ON h.id = mhp.hotel_id
                LEFT JOIN base_prices bp ON h.id = bp.hotel_id
                LEFT JOIN hotel_availability ha ON h.id = ha.hotel_id
            </when>
            <otherwise>
                LEFT JOIN base_prices bp ON h.id = bp.hotel_id
            </otherwise>
        </choose>

        WHERE 1=1

        <if test="destination != null and destination != ''">
            AND (h.hotel_name LIKE CONCAT('%', #{destination}, '%')
            OR c.city_name LIKE CONCAT('%', #{destination}, '%')
            OR co.country_name LIKE CONCAT('%', #{destination}, '%'))
        </if>

        <if test="hotelType != null and hotelType != ''">
            AND h.hotel_type = #{hotelType}
        </if>

        <if test="rating != null and rating > 0">
            AND COALESCE((SELECT AVG(rev.rating)
            FROM reviews_tbl rev
            WHERE rev.hotel_id = h.id), 0.0) &gt;= #{rating}
        </if>

        <if test="guests != null and guests > 0">
            AND EXISTS (
            SELECT 1
            FROM room_tbl r
            WHERE r.hotel_id = h.id
            AND (r.room_single_bed + (r.room_double_bed * 2)) &gt;= #{guests}
            )
        </if>

        <if test="minPrice != null or maxPrice != null">
            AND COALESCE(
            <choose>
                <when test="checkIn != null and checkOut != null">
                    mhp.avg_nightly_price,
                </when>
            </choose>
            bp.avg_nightly_price
            ) BETWEEN
            <choose>
                <when test="minPrice != null">#{minPrice}</when>
                <otherwise>0</otherwise>
            </choose>
            AND
            <choose>
                <when test="maxPrice != null">#{maxPrice}</when>
                <otherwise>999999999</otherwise>
            </choose>
        </if>

        <if test="freebies != null and freebies.size() > 0">
            <foreach collection="freebies" item="freebieId">
                AND EXISTS (
                SELECT 1
                FROM hotel_freebies_tbl hf
                WHERE hf.hotel_id = h.id
                AND hf.freebies_id = #{freebieId}
                )
            </foreach>
        </if>

        <if test="amenities != null and amenities.size() > 0">
            <foreach collection="amenities" item="amenityId">
                AND EXISTS (
                SELECT 1
                FROM hotel_amenities_tbl ha
                WHERE ha.hotel_id = h.id
                AND ha.amenities_id = #{amenityId}
                )
            </foreach>
        </if>

        <!--GROUP BY로 중복 제거 -->
        GROUP BY h.id, c.city_name, co.country_name
        <choose>
            <when test="checkIn != null and checkOut != null">
                , mhp.min_total_price, mhp.avg_nightly_price, bp.min_total_price, bp.avg_nightly_price, ha.has_available_room
            </when>
            <otherwise>
                , bp.min_total_price, bp.avg_nightly_price
            </otherwise>
        </choose>

        ORDER BY
        <choose>
            <when test="checkIn != null and checkOut != null">
                CASE WHEN ha.has_available_room = 1 THEN 0 ELSE 1 END,
            </when>
        </choose>
        <choose>
            <when test="sortBy == 'price_asc'">
                COALESCE(
                <choose>
                    <when test="checkIn != null and checkOut != null">
                        mhp.avg_nightly_price,
                    </when>
                </choose>
                bp.avg_nightly_price
                ) ASC
            </when>
            <when test="sortBy == 'price_desc'">
                COALESCE(
                <choose>
                    <when test="checkIn != null and checkOut != null">
                        mhp.avg_nightly_price,
                    </when>
                </choose>
                bp.avg_nightly_price
                ) DESC
            </when>
            <when test="sortBy == 'rating'">
                <!-- ✅ rating 정렬 수정: 서브쿼리 대신 집계 -->
                ROUND(COALESCE((SELECT AVG(rev.rating)
                FROM reviews_tbl rev
                WHERE rev.hotel_id = h.id), 0.0), 1) DESC
            </when>
            <otherwise>
                <!-- ✅ 기본 정렬도 rating으로 변경 -->
                ROUND(COALESCE((SELECT AVG(rev.rating)
                FROM reviews_tbl rev
                WHERE rev.hotel_id = h.id), 0.0), 1) DESC,
                h.hotel_star DESC
            </otherwise>
        </choose>

        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ✅ 예약 가능한 호텔만 카운트 (showing-count, tab-count용) -->
    <select id="countSearchHotels" resultType="java.lang.Long">
        WITH
        <choose>
            <when test="checkIn != null and checkOut != null">
                <!-- ... CTE 생략 ... -->
                min_hotel_prices AS (
                SELECT hotel_id, MIN(base_price) as avg_nightly_price
                FROM room_tbl
                GROUP BY hotel_id
                )
            </when>
            <when test="minPrice != null or maxPrice != null">
                min_hotel_prices AS (
                SELECT hotel_id, MIN(base_price) as avg_nightly_price
                FROM room_tbl
                GROUP BY hotel_id
                )
            </when>
            <otherwise>
                dummy_cte AS (SELECT 1 as dummy)
            </otherwise>
        </choose>

        SELECT COUNT(DISTINCT h.id)
        FROM hotel_tbl h
        LEFT JOIN city_tbl c ON h.city_id = c.id
        LEFT JOIN country_tbl co ON c.country_id = co.id
        <choose>
            <when test="checkIn != null and checkOut != null">
                <!-- ✅ LEFT JOIN으로 변경 (예약 마감 호텔도 포함) -->
                LEFT JOIN min_hotel_prices mhp ON h.id = mhp.hotel_id
            </when>
            <when test="minPrice != null or maxPrice != null">
                LEFT JOIN min_hotel_prices mhp ON h.id = mhp.hotel_id
            </when>
        </choose>
        WHERE 1=1

        <if test="destination != null and destination != ''">
            AND (h.hotel_name LIKE CONCAT('%', #{destination}, '%')
            OR c.city_name LIKE CONCAT('%', #{destination}, '%')
            OR co.country_name LIKE CONCAT('%', #{destination}, '%'))
        </if>

        <if test="hotelType != null and hotelType != ''">
            AND h.hotel_type = #{hotelType}
        </if>

        <if test="rating != null and rating > 0">
            AND h.hotel_rating &gt;= #{rating}
        </if>

        <if test="guests != null and guests > 0">
            AND EXISTS (
            SELECT 1
            FROM room_tbl r
            WHERE r.hotel_id = h.id
            AND (r.room_single_bed + (r.room_double_bed * 2)) &gt;= #{guests}
            )
        </if>

        <if test="minPrice != null or maxPrice != null">
            AND mhp.avg_nightly_price BETWEEN
            <choose>
                <when test="minPrice != null">#{minPrice}</when>
                <otherwise>0</otherwise>
            </choose>
            AND
            <choose>
                <when test="maxPrice != null">#{maxPrice}</when>
                <otherwise>999999999</otherwise>
            </choose>
        </if>

        <if test="freebies != null and freebies.size() > 0">
            <foreach collection="freebies" item="freebieId">
                AND EXISTS (
                SELECT 1
                FROM hotel_freebies_tbl hf
                WHERE hf.hotel_id = h.id
                AND hf.freebies_id = #{freebieId}
                )
            </foreach>
        </if>

        <if test="amenities != null and amenities.size() > 0">
            <foreach collection="amenities" item="amenityId">
                AND EXISTS (
                SELECT 1
                FROM hotel_amenities_tbl ha
                WHERE ha.hotel_id = h.id
                AND ha.amenities_id = #{amenityId}
                )
            </foreach>
        </if>
    </select>

    <!-- ✅ 예약 가능한 호텔만 카운트 (showing-count, tab-count용) -->
    <select id="countAvailableHotels" resultType="java.lang.Long">
        WITH
        <choose>
            <when test="checkIn != null and checkOut != null">
                date_series AS (
                SELECT DATE_ADD(#{checkIn}, INTERVAL seq DAY) as date
                FROM (
                SELECT 0 as seq UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL
                SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL
                SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL
                SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL
                SELECT 12 UNION ALL SELECT 13 UNION ALL SELECT 14 UNION ALL
                SELECT 15 UNION ALL SELECT 16 UNION ALL SELECT 17 UNION ALL
                SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20 UNION ALL
                SELECT 21 UNION ALL SELECT 22 UNION ALL SELECT 23 UNION ALL
                SELECT 24 UNION ALL SELECT 25 UNION ALL SELECT 26 UNION ALL
                SELECT 27 UNION ALL SELECT 28 UNION ALL SELECT 29 UNION ALL SELECT 30
                ) seq_table
                WHERE DATE_ADD(#{checkIn}, INTERVAL seq DAY) &lt; #{checkOut}
                ),
                night_count AS (
                SELECT COUNT(*) as nights FROM date_series
                ),
                room_prices AS (
                SELECT
                hotel_id,
                room_id,
                SUM(daily_price) as total_price,
                COUNT(pricing_id) as pricing_count,
                (SELECT nights FROM night_count) as expected_nights
                FROM (
                SELECT
                r.hotel_id,
                r.id as room_id,
                ds.date,
                rp.price as daily_price,
                rp.id as pricing_id
                FROM room_tbl r
                CROSS JOIN date_series ds
                LEFT JOIN room_pricing_tbl rp
                ON r.id = rp.room_id
                AND rp.date = ds.date
                ) room_daily_prices
                GROUP BY hotel_id, room_id
                HAVING pricing_count = expected_nights
                AND total_price > 0
                ),
                hotel_availability AS (
                SELECT
                rp.hotel_id,
                MAX(CASE
                WHEN NOT EXISTS (
                SELECT 1
                FROM reservations_tbl res
                INNER JOIN payments_tbl p ON res.id = p.reservations_id
                WHERE res.room_id = rp.room_id
                AND res.reservations_status = TRUE
                AND p.payment_status = 'paid'
                AND (
                (res.check_in_date &lt;= #{checkIn} AND res.check_out_date > #{checkIn})
                OR (res.check_in_date &lt; #{checkOut} AND res.check_out_date >= #{checkOut})
                OR (res.check_in_date >= #{checkIn} AND res.check_out_date &lt;= #{checkOut})
                )
                ) THEN 1
                ELSE 0
                END) as has_available_room
                FROM room_prices rp
                GROUP BY rp.hotel_id
                ),
                min_hotel_prices AS (
                SELECT hotel_id, MIN(base_price) as avg_nightly_price
                FROM room_tbl
                GROUP BY hotel_id
                )
            </when>
            <when test="minPrice != null or maxPrice != null">
                min_hotel_prices AS (
                SELECT hotel_id, MIN(base_price) as avg_nightly_price
                FROM room_tbl
                GROUP BY hotel_id
                )
            </when>
            <otherwise>
                dummy_cte AS (SELECT 1 as dummy)
            </otherwise>
        </choose>

        SELECT COUNT(DISTINCT h.id)
        FROM hotel_tbl h
        LEFT JOIN city_tbl c ON h.city_id = c.id
        LEFT JOIN country_tbl co ON c.country_id = co.id
        <choose>
            <when test="checkIn != null and checkOut != null">
                <!-- ✅ INNER JOIN: 예약 가능한 호텔만 카운트 -->
                INNER JOIN hotel_availability ha ON h.id = ha.hotel_id AND ha.has_available_room = 1
                LEFT JOIN min_hotel_prices mhp ON h.id = mhp.hotel_id
            </when>
            <when test="minPrice != null or maxPrice != null">
                LEFT JOIN min_hotel_prices mhp ON h.id = mhp.hotel_id
            </when>
        </choose>
        WHERE 1=1

        <if test="destination != null and destination != ''">
            AND (h.hotel_name LIKE CONCAT('%', #{destination}, '%')
            OR c.city_name LIKE CONCAT('%', #{destination}, '%')
            OR co.country_name LIKE CONCAT('%', #{destination}, '%'))
        </if>

        <if test="hotelType != null and hotelType != ''">
            AND h.hotel_type = #{hotelType}
        </if>

        <if test="rating != null and rating > 0">
            AND h.hotel_rating &gt;= #{rating}
        </if>

        <if test="guests != null and guests > 0">
            AND EXISTS (
            SELECT 1
            FROM room_tbl r
            WHERE r.hotel_id = h.id
            AND (r.room_single_bed + (r.room_double_bed * 2)) &gt;= #{guests}
            )
        </if>

        <if test="minPrice != null or maxPrice != null">
            AND mhp.avg_nightly_price BETWEEN
            <choose>
                <when test="minPrice != null">#{minPrice}</when>
                <otherwise>0</otherwise>
            </choose>
            AND
            <choose>
                <when test="maxPrice != null">#{maxPrice}</when>
                <otherwise>999999999</otherwise>
            </choose>
        </if>

        <if test="freebies != null and freebies.size() > 0">
            <foreach collection="freebies" item="freebieId">
                AND EXISTS (
                SELECT 1
                FROM hotel_freebies_tbl hf
                WHERE hf.hotel_id = h.id
                AND hf.freebies_id = #{freebieId}
                )
            </foreach>
        </if>

        <if test="amenities != null and amenities.size() > 0">
            <foreach collection="amenities" item="amenityId">
                AND EXISTS (
                SELECT 1
                FROM hotel_amenities_tbl ha
                WHERE ha.hotel_id = h.id
                AND ha.amenities_id = #{amenityId}
                )
            </foreach>
        </if>
    </select>



    <!-- 호텔 상세 조회 -->
    <select id="findHotelDetailById" resultType="com.hotel_project.hotel_jpa.hotel.dto.HotelDetailDto">
        SELECT
            h.id,
            h.hotel_name as hotelName,
            h.hotel_content as description,
            CONCAT(c.city_name, ', ', co.country_name) as address,
            c.city_name as cityName,
            co.country_name as countryName,
            h.hotel_latitude as latitude,
            h.hotel_longitude as longitude,
            h.hotel_number as phoneNumber,
            h.hotel_type as hotelType,
            h.hotel_star as starRating,
            -- 실제 리뷰 평균 평점 계산
            ROUND(COALESCE((SELECT AVG(r.rating)
                            FROM reviews_tbl r
                            WHERE r.hotel_id = h.id), 0.0), 1) as averageRating,
            -- 실제 리뷰 개수 계산
            COALESCE((SELECT COUNT(*)
                      FROM reviews_tbl r
                      WHERE r.hotel_id = h.id), 0) as reviewCount,
            h.checkin_time as checkInTime,
            h.checkout_time as checkOutTime,
            (SELECT MIN(r.base_price)
             FROM room_tbl r
             WHERE r.hotel_id = h.id) as minPrice,
            FALSE as wishlisted
        FROM hotel_tbl h
                 LEFT JOIN city_tbl c ON h.city_id = c.id
                 LEFT JOIN country_tbl co ON c.country_id = co.id
        WHERE h.id = #{hotelId}
    </select>

    <!-- 호텔의 무료 서비스 조회 -->
    <select id="findFreebiesByHotelId" resultType="com.hotel_project.hotel_jpa.freebies.dto.FreebiesDto">
        SELECT
            f.id,
            f.freebies_name as freebiesName
        FROM freebies_tbl f
                 INNER JOIN hotel_freebies_tbl hf ON f.id = hf.freebies_id
        WHERE hf.hotel_id = #{hotelId}
        ORDER BY f.id
    </select>

    <!-- 호텔의 편의시설 조회 -->
    <select id="findAmenitiesByHotelId" resultType="com.hotel_project.hotel_jpa.amenities.dto.AmenitiesDto">
        SELECT
            a.id,
            a.amenities_name as amenitiesName
        FROM amenities_tbl a
                 INNER JOIN hotel_amenities_tbl ha ON a.id = ha.amenities_id
        WHERE ha.hotel_id = #{hotelId}
        ORDER BY a.id
    </select>

    <!-- 호텔 이미지 조회 -->
    <select id="findImagesByHotelId" resultType="java.lang.String">
        SELECT hotel_image_path
        FROM hotel_image_tbl
        WHERE hotel_id = #{hotelId}
        ORDER BY created_at ASC
    </select>

    <!-- 호텔의 객실 조회 (날짜별 가용성 포함) -->
    <select id="findAvailableRoomsByHotelId" resultType="com.hotel_project.hotel_jpa.room.dto.RoomDto">
        SELECT
            r.id,
            r.hotel_id as hotelId,
            r.room_name as roomName,
            r.room_single_bed as roomSingleBed,
            r.room_double_bed as roomDoubleBed,
            COALESCE(rp.price, r.base_price) as basePrice,
            r.room_number as roomNumber,
            r.room_view as roomView,
            r.created_at as createdAt,
            r.updated_at as updatedAt
        FROM room_tbl r
                 LEFT JOIN room_pricing_tbl rp ON r.id = rp.room_id
            AND rp.date BETWEEN #{checkIn} AND #{checkOut}
        WHERE r.hotel_id = #{hotelId}
        GROUP BY r.id
        ORDER BY r.base_price ASC
    </select>

    <!-- 호텔의 전체 객실 조회 -->
    <select id="findRoomsByHotelId" resultType="com.hotel_project.hotel_jpa.room.dto.RoomDto">
        SELECT
            r.id,
            r.hotel_id as hotelId,
            r.room_name as roomName,
            r.room_single_bed as roomSingleBed,
            r.room_double_bed as roomDoubleBed,
            r.base_price as basePrice,
            r.room_number as roomNumber,
            r.room_view as roomView,
            r.created_at as createdAt,
            r.updated_at as updatedAt
        FROM room_tbl r
        WHERE r.hotel_id = #{hotelId}
        ORDER BY r.base_price ASC
    </select>

    <!-- 호텔 리뷰 조회 -->
    <select id="findReviewsByHotelId" resultType="com.hotel_project.review_jpa.reviews.dto.ReviewsDto">
        SELECT
            r.id,
            r.member_id as memberId,
            r.hotel_id as hotelId,
            r.reservations_id as reservationsId,
            r.rating,
            r.review_content as reviewContent,
            r.review_card as reviewCard,
            r.created_at as createdAt,
            r.updated_at as updatedAt
        FROM reviews_tbl r
        WHERE r.hotel_id = #{hotelId}
        ORDER BY r.created_at DESC
            LIMIT 18446744073709551615 OFFSET #{offset}
    </select>

    <!-- 무료 서비스 옵션 조회 -->
    <select id="findFreebiesOptions" resultType="com.hotel_project.hotel_jpa.freebies.dto.FreebiesDto">
        SELECT
            id,
            freebies_name as freebiesName
        FROM freebies_tbl
        ORDER BY id
    </select>

    <!-- 편의시설 옵션 조회 -->
    <select id="findAmenitiesOptions" resultType="com.hotel_project.hotel_jpa.amenities.dto.AmenitiesDto">
        SELECT
            id,
            amenities_name as amenitiesName
        FROM amenities_tbl
        ORDER BY id
    </select>

    <!-- 가격 범위 조회 -->
    <select id="findPriceRange" resultType="com.hotel_project.hotel_jpa.hotel.dto.PriceRangeDto">
        SELECT
            MIN(base_price) as min,
            MAX(base_price) as max
        FROM room_tbl
    </select>

    <!-- 호텔 타입별 개수 조회 -->
    <select id="countByType" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM hotel_tbl
        WHERE hotel_type = #{hotelType}
    </select>

    <!-- 검색 조건에 따른 호텔 타입별 개수 조회 -->
    <select id="countByTypeWithFilters" resultType="java.lang.Long">
        WITH
        <choose>
            <when test="checkIn != null and checkOut != null">
                date_series AS (
                SELECT DATE_ADD(#{checkIn}, INTERVAL seq DAY) as date
                FROM (
                SELECT 0 as seq UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL
                SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL
                SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL
                SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL
                SELECT 12 UNION ALL SELECT 13 UNION ALL SELECT 14 UNION ALL
                SELECT 15 UNION ALL SELECT 16 UNION ALL SELECT 17 UNION ALL
                SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20 UNION ALL
                SELECT 21 UNION ALL SELECT 22 UNION ALL SELECT 23 UNION ALL
                SELECT 24 UNION ALL SELECT 25 UNION ALL SELECT 26 UNION ALL
                SELECT 27 UNION ALL SELECT 28 UNION ALL SELECT 29 UNION ALL SELECT 30
                ) seq_table
                WHERE DATE_ADD(#{checkIn}, INTERVAL seq DAY) &lt; #{checkOut}
                ),
                night_count AS (
                SELECT COUNT(*) as nights FROM date_series
                ),
                room_daily_prices AS (
                SELECT
                r.hotel_id,
                r.id as room_id,
                ds.date,
                rp.price as daily_price,
                rp.id as pricing_id
                FROM room_tbl r
                CROSS JOIN date_series ds
                LEFT JOIN room_pricing_tbl rp
                ON r.id = rp.room_id
                AND rp.date = ds.date
                ),
                room_prices AS (
                SELECT
                hotel_id,
                room_id,
                SUM(daily_price) as total_price,
                COUNT(pricing_id) as pricing_count,
                (SELECT nights FROM night_count) as expected_nights
                FROM room_daily_prices
                GROUP BY hotel_id, room_id
                HAVING pricing_count = expected_nights
                AND total_price > 0
                ),
                min_hotel_prices AS (
                SELECT
                rp.hotel_id,
                MIN(rp.total_price) / nc.nights as avg_nightly_price
                FROM room_prices rp
                CROSS JOIN night_count nc
                GROUP BY rp.hotel_id, nc.nights
                )
            </when>
            <when test="minPrice != null or maxPrice != null">
                min_hotel_prices AS (
                SELECT
                hotel_id,
                MIN(base_price) as avg_nightly_price
                FROM room_tbl
                GROUP BY hotel_id
                )
            </when>
            <otherwise>
                dummy_cte AS (SELECT 1 as dummy)
            </otherwise>
        </choose>

        SELECT COUNT(DISTINCT h.id)
        FROM hotel_tbl h
        LEFT JOIN city_tbl c ON h.city_id = c.id
        LEFT JOIN country_tbl co ON c.country_id = co.id
        <choose>
            <when test="checkIn != null and checkOut != null">
                LEFT JOIN min_hotel_prices mhp ON h.id = mhp.hotel_id
            </when>
            <when test="minPrice != null or maxPrice != null">
                LEFT JOIN min_hotel_prices mhp ON h.id = mhp.hotel_id
            </when>
        </choose>
        WHERE h.hotel_type = #{hotelType}

        <if test="destination != null and destination != ''">
            AND (h.hotel_name LIKE CONCAT('%', #{destination}, '%')
            OR c.city_name LIKE CONCAT('%', #{destination}, '%')
            OR co.country_name LIKE CONCAT('%', #{destination}, '%'))
        </if>

        <if test="rating != null and rating > 0">
            AND h.hotel_rating &gt;= #{rating}
        </if>

        <if test="guests != null and guests > 0">
            AND EXISTS (
            SELECT 1
            FROM room_tbl r
            WHERE r.hotel_id = h.id
            AND (r.room_single_bed + (r.room_double_bed * 2)) &gt;= #{guests}
            )
        </if>

        <if test="minPrice != null or maxPrice != null">
            AND mhp.avg_nightly_price BETWEEN
            <choose>
                <when test="minPrice != null">#{minPrice}</when>
                <otherwise>0</otherwise>
            </choose>
            AND
            <choose>
                <when test="maxPrice != null">#{maxPrice}</when>
                <otherwise>999999999</otherwise>
            </choose>
        </if>

        <if test="freebies != null and freebies.size() > 0">
            <foreach collection="freebies" item="freebieId">
                AND EXISTS (
                SELECT 1
                FROM hotel_freebies_tbl hf
                WHERE hf.hotel_id = h.id
                AND hf.freebies_id = #{freebieId}
                )
            </foreach>
        </if>

        <if test="amenities != null and amenities.size() > 0">
            <foreach collection="amenities" item="amenityId">
                AND EXISTS (
                SELECT 1
                FROM hotel_amenities_tbl ha
                WHERE ha.hotel_id = h.id
                AND ha.amenities_id = #{amenityId}
                )
            </foreach>
        </if>
    </select>



</mapper>