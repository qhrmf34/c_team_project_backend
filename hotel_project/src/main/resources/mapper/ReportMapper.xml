<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hotel_project.review_jpa.report.mapper.ReportMapper">

    <resultMap id="ReportDtoMap" type="com.hotel_project.review_jpa.report.dto.ReportDto">
        <id property="id" column="id"/>
        <result property="reviewsId" column="reviews_id"/>
        <result property="memberId" column="member_id"/>
        <result property="reportType" column="report_type"/>
        <result property="reportContent" column="report_content"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 특정 리뷰의 신고 목록 조회 -->
    <select id="findByReviewId" resultMap="ReportDtoMap">
        SELECT
            r.id,
            r.reviews_id,
            r.member_id,
            r.report_type,
            r.report_content,
            r.created_at,
            m.first_name,
            m.last_name
        FROM reports_tbl r
                 LEFT JOIN members_tbl m ON r.member_id = m.id
        WHERE r.reviews_id = #{reviewId}
        ORDER BY r.created_at DESC
    </select>

    <!-- 중복 신고 체크 -->
    <select id="existsByMemberIdAndReviewId" resultType="boolean">
        SELECT
            CASE
                WHEN COUNT(*) > 0 THEN TRUE
                ELSE FALSE
                END
        FROM reports_tbl
        WHERE member_id = #{memberId}
          AND reviews_id = #{reviewId}
    </select>

</mapper>