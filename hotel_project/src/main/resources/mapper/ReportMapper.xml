<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hotel_project.review_jpa.report.mapper.ReportMapper">

    <resultMap id="ReportDtoMap" type="com.hotel_project.review_jpa.report.dto.ReportDto">
        <id property="id" column="id"/>
        <result property="reviewsId" column="reviews_id"/>
        <result property="memberId" column="member_id"/>
        <result property="reportType" column="report_type"/>
        <result property="reportContent" column="report_content"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <select id="findByReviewId" resultMap="ReportDtoMap">
        SELECT
            r.id,
            r.reviews_id,
            r.member_id,
            r.report_type,
            r.report_content,
            r.created_at,
            m.first_name,
            m.last_name
        FROM reports_tbl r
                 LEFT JOIN member_tbl m ON r.member_id = m.id
        WHERE r.reviews_id = #{reviewId}
        ORDER BY r.created_at DESC
    </select>

    <select id="existsByMemberIdAndReviewId" resultType="boolean">
        SELECT
            CASE
                WHEN COUNT(*) > 0 THEN TRUE
                ELSE FALSE
                END
        FROM reports_tbl
        WHERE member_id = #{memberId}
          AND reviews_id = #{reviewId}
    </select>

    <!-- 리뷰 작성자 ID 조회 -->
    <select id="getReviewOwnerId" resultType="long">
        SELECT member_id
        FROM reviews_tbl
        WHERE id = #{reviewId}
    </select>

    <!-- 신고 등록 -->
    <insert id="insertReport" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reports_tbl (
            reviews_id,
            member_id,
            report_type,
            report_content,
            created_at
        ) VALUES (
                     #{reviewsId},
                     #{memberId},
                     #{reportType},
                     #{reportContent},
                     NOW()
                 )
    </insert>

</mapper>